/**
====================================================
 Express.js â€“ Error Handling Middleware
====================================================

----------------------------------------------------
ðŸ”¹ Sabse pehle samjho: Error Handling Middleware kya hota hai?

Error Handling Middleware = Express ka special middleware
jo application me aane wale errors ko handle karta hai.

ðŸ‘‰ Iska kaam:
- server crash hone se bachana
- client ko proper error response dena
- code ko clean & professional banana

----------------------------------------------------
ðŸ”¹ Error Handling Middleware ka SPECIAL syntax

âš ï¸ Normal middleware:
(req, res, next)

âš ï¸ Error middleware:
(err, req, res, next)

ðŸ‘‰ Pehla parameter **err** hona hi chahiye
ðŸ‘‰ Isi se Express samajhta hai ki ye error middleware hai

----------------------------------------------------
ðŸ”¹ Error kaise aata hai Express me?

Error 2 tareeke se aa sakta hai:

1ï¸âƒ£ Manually (developer khud error bheje)
   next(new Error("Something went wrong"))

2ï¸âƒ£ Automatically (JS error)
   - JSON parse error
   - undefined access
   - DB error etc.

----------------------------------------------------
ðŸ”¹ Basic Error Handling Middleware Example

import express from "express";
const app = express();

app.get("/error", (req, res, next) => {
  const error = new Error("Something went wrong");
  next(error); // error forward kiya
});

// Error handling middleware (ALWAYS last)
app.use((err, req, res, next) => {
  res.status(500).send(err.message);
});

----------------------------------------------------
ðŸ”¹ Dry Run (Step-by-step)

Request:
GET /error

Execution flow:
1) Request /error aayi
2) Route match hua
3) new Error() bana
4) next(error) call hua
5) Express samajh gaya ki error aaya hai
6) Normal routes skip ho gaye
7) Seedha error middleware pe gaya
8) err.message response me bhej diya
9) Response close

Output:
Something went wrong

----------------------------------------------------
ðŸ”¹ IMPORTANT RULE (Golden Rule)

âŒ Error middleware ko kabhi upar mat likho  
âœ… Hamesha **sab routes ke baad** likho

Kyun?
ðŸ‘‰ Express error middleware ko tabhi call karta hai
jab usse pehle koi error aata hai

----------------------------------------------------
ðŸ”¹ next(err) vs next()

next()      â†’ normal flow continue  
next(err)   â†’ error flow start  

ðŸ‘‰ Jaise hi next(err) likha:
- Express direct error middleware pe jump karta hai
- Beech ke normal routes skip ho jaate hain

----------------------------------------------------
ðŸ”¹ Real-world example (Auth error)

const authMiddleware = (req, res, next) => {
  const isLoggedIn = false;

  if (!isLoggedIn) {
    return next(new Error("User not authenticated"));
  }

  next();
};

app.get("/profile", authMiddleware, (req, res) => {
  res.send("User Profile");
});

----------------------------------------------------
ðŸ”¹ Dry Run (Auth error case)

Request:
GET /profile

Execution flow:
1) authMiddleware chala
2) isLoggedIn = false
3) next(new Error()) call hua
4) Express error flow me chala gaya
5) Controller skip ho gaya
6) Error middleware execute hua
7) Error response send hua

----------------------------------------------------
ðŸ”¹ Global Error Handler (Professional way)

app.use((err, req, res, next) => {
  const statusCode = err.statusCode || 500;
  const message = err.message || "Internal Server Error";

  res.status(statusCode).json({
    success: false,
    message: message,
  });
});

----------------------------------------------------
ðŸ”¹ Custom Error Class (Industry standard)

class AppError extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode;
  }
}

Usage:
return next(new AppError("User not found", 404));

----------------------------------------------------
ðŸ”¹ Async Error Problem (VERY IMPORTANT)

âŒ Ye error catch nahi hoga:
app.get("/data", async (req, res) => {
  throw new Error("Async error");
});

ðŸ‘‰ Kyunki async error automatically next(err) me nahi jata

----------------------------------------------------
ðŸ”¹ Async Error Solution (Correct way)

app.get("/data", async (req, res, next) => {
  try {
    throw new Error("Async error");
  } catch (err) {
    next(err); // manually forward
  }
});

----------------------------------------------------
ðŸ”¹ Shortcut (Production trick)

const asyncHandler = (fn) => {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

Usage:
app.get(
  "/data",
  asyncHandler(async (req, res) => {
    throw new Error("Async error");
  })
);

----------------------------------------------------
ðŸ”¹ Folder Structure (Error handling included)

project/
â”‚
â”œâ”€â”€ server.js
â”œâ”€â”€ routes/
â”œâ”€â”€ controllers/
â”œâ”€â”€ middlewares/
â”‚   â””â”€â”€ error.middleware.js
â”‚
â””â”€â”€ utils/
    â””â”€â”€ AppError.js

----------------------------------------------------
 FINAL 

1ï¸âƒ£ Error middleware me 4 params hote hain  
2ï¸âƒ£ next(err) error flow start karta hai  
3ï¸âƒ£ Error middleware ALWAYS last me hota hai  
4ï¸âƒ£ Async errors ko manually handle karna padta hai  
5ï¸âƒ£ Global error handler = clean & safe app  

====================================================
*/

/**
  Express.js Global Handlers Notes

1ï¸âƒ£ Problem we faced:

- Pehle humne router ya app me catch-all route define kiya using '*' ya '/*':
    router.all('*', (req, res) => {...})
  ya
    router.all('/*', (req, res) => {...})

- Error aaya:
    PathError [TypeError]: Missing parameter name at index 1: *

- Reason:
  Latest Express + Node + path-to-regexp parser strict ho gaya hai. 
  '*' ya '/*' directly router.all() ya app.all() me pass karne se parser confuse ho jaata hai aur crash ho jaata hai.

---

2ï¸âƒ£ Solution / Best Practice:

- **404 Handler (Route Not Found)**

  - Sirf undefined routes ko handle karne ke liye.
  - **Router ke andar catch-all avoid karo**.
  - Global app level pe use karo:
    
    app.use((req, res) => {
      res.status(404).json({
        status: "fail",
        message: `Cannot find ${req.originalUrl} on this server`,
      });
    });

  âœ… Ye production-safe aur real-world standard approach hai.
  âœ… Koi '*' ya '/*' specify karne ki zarurat nahi.
  âœ… Industry me sab aise use karte hain.

- **Global Error Handler (Runtime Errors)**

  - Runtime errors / thrown exceptions / DB errors ke liye use hota hai.
  - Signature **must have 4 parameters**: (err, req, res, next)
    
    app.use((err, req, res, next) => {
      console.error(err.stack);
      res.status(err.statusCode || 500).json({
        status: "error",
        message: err.message || "Something went wrong!",
      });
    });

  âœ… Agar 4 parameters nahi honge, Express is middleware ko normal samjhega aur error handle nahi hoga.
  âœ… Ye real-world me har production app me hota hai.

---

  Real-world me dono use hote hain:

- **404 handler** â†’ jab route exist nahi karta
- **Global error handler** â†’ jab route me kuch galat ho jaye (DB error, validation fail, exception)
*/

